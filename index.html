<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gasolineras Espa√±a - Busca el mejor precio</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header moderno */
        .header {
            background: linear-gradient(135deg, #1a56db 0%, #1e40af 100%);
            color: white;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
            z-index: 1000;
        }

        .header-top {
            margin-bottom: 16px;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header-subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* Selector de combustible en chips */
        .combustible-selector {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 4px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .combustible-selector::-webkit-scrollbar {
            display: none;
        }

        .fuel-chip {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
            min-height: 44px;
        }

        .fuel-chip:hover {
            background: rgba(255,255,255,0.3);
        }

        .fuel-chip.active {
            background: rgba(255,255,255,0.95);
            color: #1a56db;
            border-color: rgba(255,255,255,0.8);
        }

        .fuel-icon {
            font-size: 1rem;
        }

        /* Controles de b√∫squeda */
        .search-controls {
            padding: 16px;
            background: white;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .search-field {
            position: relative;
            margin-bottom: 16px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            background: #f8fafc;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #1a56db;
            background: white;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            color: #64748b;
        }

        .search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #1a56db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .search-btn:hover {
            background: #1e40af;
        }

        /* Slider de radio */
        .radio-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .radio-label {
            font-size: 0.875rem;
            color: #64748b;
            white-space: nowrap;
        }

        .radio-slider {
            flex: 1;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            outline: none;
            appearance: none;
        }

        .radio-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: #1a56db;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .radio-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #1a56db;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .radio-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1a56db;
            min-width: 60px;
            text-align: center;
        }

        /* Mapa */
        .mapa-container {
            position: relative;
            height: 45vh;
            margin: 16px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        #mapa {
            height: 100%;
            width: 100%;
        }

        /* Info del mapa */
        .mapa-info {
            position: absolute;
            top: 16px;
            left: 16px;
            right: 16px;
            background: rgba(255,255,255,0.95);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.875rem;
            color: #64748b;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: #1a56db;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(26,86,219,0.4);
            transition: all 0.2s ease;
            z-index: 1001;
        }

        .fab:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(26,86,219,0.5);
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* Listado de gasolineras */
        .listado-container {
            flex: 1;
            background: white;
            margin: 0 16px 16px 16px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .listado-header {
            background: #f8fafc;
            padding: 16px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .listado-titulo {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1a56db;
        }

        .listado-info {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 4px;
        }

        .listado {
            max-height: 50vh;
            overflow-y: auto;
            padding: 8px;
        }

        .gasolinera-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .gasolinera-card:hover {
            border-color: #1a56db;
            box-shadow: 0 2px 8px rgba(26,86,219,0.1);
        }

        .gasolinera-card.selected {
            border-color: #1a56db;
            background: #f0f7ff;
        }

        .gasolinera-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .gasolinera-nombre {
            font-weight: 600;
            color: #1e293b;
            flex: 1;
        }

        .precio-badge {
            background: #10b981;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .precio-badge.medio {
            background: #f59e0b;
        }

        .precio-badge.caro {
            background: #ef4444;
        }

        .gasolinera-info {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 8px;
        }

        .gasolinera-acciones {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .gasolinera-distancia {
            font-size: 0.875rem;
            color: #64748b;
        }

        .ruta-btn {
            background: #1a56db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ruta-btn:hover {
            background: #1e40af;
        }

        /* Estado de carga */
        .loading {
            text-align: center;
            padding: 24px;
            color: #64748b;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 50%;
            border-top-color: #1a56db;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .mapa-container {
                height: 40vh;
                margin: 12px;
            }
            
            .listado {
                max-height: 45vh;
            }
            
            .fab {
                bottom: 16px;
                right: 16px;
                width: 48px;
                height: 48px;
                font-size: 1.25rem;
            }
        }

        /* Estilo para los marcadores con texto */
        .mapa-marker {
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
        }
        .mapa-marker .marker-text-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .mapa-marker .marker-circle {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            margin-top: 2px;
        }
        .mapa-marker .marker-text {
            font-size: 0.85rem;
            font-weight: 700;
            white-space: nowrap;
            color: #1e293b;
            background: rgba(255,255,255,0.85);
            padding: 3px 6px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .mapa-marker .marker-circle.barato { background: #10b981; }
        .mapa-marker .marker-circle.medio { background: #f59e0b; }
        .mapa-marker .marker-circle.caro { background: #ef4444; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header moderno -->
        <header class="header">
            <div class="header-top">
                <h1 class="header-title">‚õΩ Gasolineras</h1>
                <span class="header-subtitle">Encuentra el mejor precio cerca de ti</span>
            </div>
            
            <!-- Selector de combustible en chips -->
            <div class="combustible-selector">
                <button class="fuel-chip" data-fuel="Precio Gasoleo A">
                    <span class="fuel-icon">‚õΩ</span>
                    <span class="fuel-name">Di√©sel</span>
                </button>
                <button class="fuel-chip" data-fuel="Precio Gasolina 95 E5">
                    <span class="fuel-icon">üöó</span>
                    <span class="fuel-name">95</span>
                </button>
                <button class="fuel-chip" data-fuel="Precio Gasolina 98 E5">
                    <span class="fuel-icon">üèéÔ∏è</span>
                    <span class="fuel-name">98</span>
                </button>
                <button class="fuel-chip" data-fuel="Precio Gasoleo Premium">
                    <span class="fuel-icon">üíé</span>
                    <span class="fuel-name">Di√©sel+</span>
                </button>
                <button class="fuel-chip" data-fuel="Precio Biodiesel">
                    <span class="fuel-icon">üå±</span>
                    <span class="fuel-name">Bio</span>
                </button>
                <button class="fuel-chip" data-fuel="Precio Bioetanol">
                    <span class="fuel-icon">üåø</span>
                    <span class="fuel-name">E85</span>
                </button>
            </div>
        </header>

        <!-- Controles de b√∫squeda -->
        <div class="search-controls">
            <div class="search-field">
                <span class="search-icon">üîç</span>
                <input type="text" id="direccionInput" class="search-input" 
                       placeholder="Buscar direcci√≥n o ciudad...">
                <button id="buscarBtn" class="search-btn">Buscar</button>
            </div>
            
            <div class="radio-control">
                <label class="radio-label">Radio:</label>
                <input type="range" id="radioSlider" class="radio-slider" 
                       min="1" max="80" value="5">
                <span id="radioValue" class="radio-value">5 km</span>
            </div>
        </div>

        <!-- Mapa -->
        <div class="mapa-container">
            <div id="mapaInfo" class="mapa-info">
                üìç Obteniendo tu ubicaci√≥n...
            </div>
            <div id="mapa"></div>
        </div>

        <!-- Listado de gasolineras -->
        <div class="listado-container">
            <div class="listado-header">
                <div class="listado-titulo">üèÜ Mejores Precios</div>
                <div class="listado-info">Ordenado de menor a mayor precio</div>
            </div>
            <div id="listado" class="listado">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Iniciando aplicaci√≥n...
                </div>
            </div>
        </div>

        <!-- Floating Action Button -->
        <button id="ubicacionBtn" class="fab" title="Mi ubicaci√≥n">
            üìç
        </button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Aplicaci√≥n de Gasolineras Espa√±a - Versi√≥n con persistencia mejorada
        class GasolinerasApp {
            constructor() {
                this.mapa = null;
                this.marcadores = [];
                this.gasolineras = [];
                this.ubicacionActual = null;
                this.combustibleSeleccionado = 'Precio Gasoleo A';
                this.radioKm = 5;
                this.gasolineraSeleccionada = null;
                this.inicioAutomatico = true; // Flag para inicio autom√°tico

                // Configuraci√≥n de colores para marcadores
                this.colores = {
                    barato: '#10b981',
                    medio: '#f59e0b',
                    caro: '#ef4444'
                };

                // Claves para localStorage
                this.STORAGE_KEYS = {
                    combustible: 'gasolineras_combustible_preferido',
                    ubicacion: 'gasolineras_ultima_ubicacion',
                    radio: 'gasolineras_radio_preferido'
                };

                this.init();
            }

            init() {
                this.initMapa();
                this.cargarPreferenciasGuardadas();
                this.initEventListeners();
                
                // Inicio autom√°tico con GPS o √∫ltima ubicaci√≥n
                this.iniciarAutomaticamente();
            }

            // Nueva funci√≥n: cargar preferencias del localStorage
            cargarPreferenciasGuardadas() {
                // Cargar combustible preferido
                const combustibleGuardado = localStorage.getItem(this.STORAGE_KEYS.combustible);
                if (combustibleGuardado) {
                    this.combustibleSeleccionado = combustibleGuardado;
                    this.actualizarSelectorCombustible();
                }

                // Cargar radio preferido
                const radioGuardado = localStorage.getItem(this.STORAGE_KEYS.radio);
                if (radioGuardado) {
                    this.radioKm = parseInt(radioGuardado);
                    document.getElementById('radioSlider').value = this.radioKm;
                    document.getElementById('radioValue').textContent = `${this.radioKm} km`;
                }
            }

            // Nueva funci√≥n: actualizar selector de combustible visualmente
            actualizarSelectorCombustible() {
                document.querySelectorAll('.fuel-chip').forEach(chip => {
                    chip.classList.remove('active');
                    if (chip.dataset.fuel === this.combustibleSeleccionado) {
                        chip.classList.add('active');
                    }
                });
            }

            // Nueva funci√≥n: guardar preferencias en localStorage
            guardarPreferencias() {
                localStorage.setItem(this.STORAGE_KEYS.combustible, this.combustibleSeleccionado);
                localStorage.setItem(this.STORAGE_KEYS.radio, this.radioKm.toString());
                
                if (this.ubicacionActual) {
                    localStorage.setItem(this.STORAGE_KEYS.ubicacion, JSON.stringify(this.ubicacionActual));
                }
            }

            // Nueva funci√≥n: iniciar autom√°ticamente con GPS o √∫ltima ubicaci√≥n
            async iniciarAutomaticamente() {
                this.updateMapInfo('üîç Iniciando aplicaci√≥n...');
                
                // Intentar GPS primero
                if (navigator.geolocation) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, {
                                enableHighAccuracy: true,
                                timeout: 8000,
                                maximumAge: 300000
                            });
                        });

                        const { latitude, longitude } = position.coords;
                        this.ubicacionActual = { lat: latitude, lng: longitude };
                        this.mapa.setView([latitude, longitude], 16);
                        this.updateMapInfo('üìç Ubicaci√≥n GPS obtenida');
                        await this.cargarGasolineras();
                        return; // GPS exitoso, salir

                    } catch (error) {
                        console.log('GPS no disponible, intentando con √∫ltima ubicaci√≥n...');
                    }
                }

                // Si GPS falla, usar √∫ltima ubicaci√≥n guardada
                const ubicacionGuardada = localStorage.getItem(this.STORAGE_KEYS.ubicacion);
                if (ubicacionGuardada) {
                    try {
                        this.ubicacionActual = JSON.parse(ubicacionGuardada);
                        this.mapa.setView([this.ubicacionActual.lat, this.ubicacionActual.lng], 16);
                        this.updateMapInfo('üìç Usando √∫ltima ubicaci√≥n guardada');
                        await this.cargarGasolineras();
                        return; // √öltima ubicaci√≥n exitosa
                    } catch (error) {
                        console.error('Error cargando ubicaci√≥n guardada:', error);
                    }
                }

                // Si todo falla, mostrar mensaje para que el usuario busque
                this.updateMapInfo('üìç Pulsa el bot√≥n GPS o busca una direcci√≥n para empezar');
                document.getElementById('listado').innerHTML = `
                    <div class="loading">
                        <div>Pulsa üìç para obtener tu ubicaci√≥n actual<br>o busca una direcci√≥n manualmente</div>
                    </div>
                `;
            }

            initMapa() {
                this.mapa = L.map('mapa', {
                    center: [40.4168, -3.7038],
                    zoom: 6,
                    zoomControl: true
                });

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(this.mapa);

                this.mapa.zoomControl.setPosition('bottomleft');
            }

            initEventListeners() {
                // Selector de combustible
                document.querySelectorAll('.fuel-chip').forEach(chip => {
                    chip.addEventListener('click', (e) => {
                        document.querySelectorAll('.fuel-chip').forEach(c => c.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        this.combustibleSeleccionado = e.currentTarget.dataset.fuel;
                        
                        // Guardar preferencia inmediatamente
                        this.guardarPreferencias();
                        
                        if (this.gasolineras.length > 0) {
                            this.procesarGasolineras(this.gasolineras);
                        }
                    });
                });

                // Bot√≥n de geolocalizaci√≥n (FAB)
                document.getElementById('ubicacionBtn').addEventListener('click', () => {
                    this.obtenerUbicacion();
                });

                // B√∫squeda por direcci√≥n
                document.getElementById('buscarBtn').addEventListener('click', () => {
                    this.buscarDireccion();
                });

                document.getElementById('direccionInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.buscarDireccion();
                    }
                });

                // Slider de radio
                const slider = document.getElementById('radioSlider');
                const valueLabel = document.getElementById('radioValue');
                
                slider.addEventListener('input', (e) => {
                    this.radioKm = parseInt(e.target.value);
                    valueLabel.textContent = `${this.radioKm} km`;
                    
                    // Guardar preferencia inmediatamente
                    this.guardarPreferencias();
                    
                    if (this.gasolineras.length > 0) {
                        this.procesarGasolineras(this.gasolineras);
                    }
                });
            }

            async obtenerUbicacion() {
                const btn = document.getElementById('ubicacionBtn');
                btn.style.transform = 'scale(0.9)';
                btn.innerHTML = '‚è≥';
                
                this.updateMapInfo('üîç Obteniendo tu ubicaci√≥n...');

                if (!navigator.geolocation) {
                    this.showError('Tu navegador no soporta geolocalizaci√≥n');
                    this.resetFabButton();
                    return;
                }

                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 300000
                        });
                    });

                    const { latitude, longitude } = position.coords;
                    this.ubicacionActual = { lat: latitude, lng: longitude };
                    this.mapa.setView([latitude, longitude], 16);
                    
                    // Guardar ubicaci√≥n inmediatamente
                    this.guardarPreferencias();
                    
                    await this.cargarGasolineras();
                    this.resetFabButton();
                    
                } catch (error) {
                    this.showError('No se pudo obtener tu ubicaci√≥n. Intenta buscar una direcci√≥n.');
                    this.resetFabButton();
                }
            }

            async buscarDireccion() {
                const direccion = document.getElementById('direccionInput').value.trim();
                if (!direccion) {
                    alert('Introduce una direcci√≥n o ciudad');
                    return;
                }

                this.updateMapInfo('üîç Buscando direcci√≥n...');

                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion)}&limit=1&countrycodes=es`
                    );
                    const results = await response.json();

                    if (results.length === 0) {
                        this.showError('Direcci√≥n no encontrada. Intenta con otra b√∫squeda.');
                        return;
                    }

                    const result = results[0];
                    this.ubicacionActual = {
                        lat: parseFloat(result.lat),
                        lng: parseFloat(result.lon)
                    };

                    this.mapa.setView([this.ubicacionActual.lat, this.ubicacionActual.lng], 16);
                    
                    // Guardar ubicaci√≥n inmediatamente
                    this.guardarPreferencias();
                    
                    await this.cargarGasolineras();
                    
                } catch (error) {
                    this.showError('Error al buscar la direcci√≥n. Int√©ntalo de nuevo.');
                }
            }

            async cargarGasolineras() {
                this.updateMapInfo('‚õΩ Cargando gasolineras...');
                document.getElementById('listado').innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Cargando gasolineras oficiales...
                    </div>
                `;

                try {
                    const response = await fetch(
                        'https://sedeaplicaciones.minetur.gob.es/ServiciosRESTCarburantes/PreciosCarburantes/EstacionesTerrestres/',
                        { 
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json'
                            }
                        }
                    );

                    if (!response.ok) {
                        throw new Error('Error al obtener datos');
                    }

                    const data = await response.json();
                    this.gasolineras = data.ListaEESSPrecio || [];
                    this.procesarGasolineras(this.gasolineras);
                    
                } catch (error) {
                    console.error('Error:', error);
                    this.showError('Error al cargar las gasolineras. Int√©ntalo de nuevo.');
                }
            }

            procesarGasolineras(gasolinerasRaw) {
                if (!this.ubicacionActual) return;

                this.marcadores.forEach(marker => this.mapa.removeLayer(marker));
                this.marcadores = [];

                const gasolinerasProcesadas = gasolinerasRaw
                    .map(g => this.procesarGasolinera(g))
                    .filter(g => g !== null)
                    .filter(g => g.distancia <= this.radioKm)
                    .sort((a, b) => a.precio - b.precio);

                if (gasolinerasProcesadas.length === 0) {
                    this.updateMapInfo(`‚ùå No hay gasolineras en ${this.radioKm}km con precios de ${this.getNombreCombustible()}`);
                    document.getElementById('listado').innerHTML = `
                        <div class="loading">
                            No se encontraron gasolineras en el radio seleccionado.<br>
                            <small>Intenta aumentar el radio de b√∫squeda</small>
                        </div>
                    `;
                    return;
                }

                this.crearMarcadores(gasolinerasProcesadas);
                this.actualizarListado(gasolinerasProcesadas);
                this.marcarUbicacionUsuario();

                this.updateMapInfo(`‚úÖ ${gasolinerasProcesadas.length} gasolineras encontradas`);
            }

            procesarGasolinera(g) {
                try {
                    const lat = parseFloat(g.Latitud?.replace(',', '.'));
                    const lng = parseFloat(g['Longitud (WGS84)']?.replace(',', '.'));
                    const precioStr = g[this.combustibleSeleccionado]?.replace(',', '.');
                    const precio = parseFloat(precioStr);

                    if (isNaN(lat) || isNaN(lng) || isNaN(precio) || precio === 0) {
                        return null;
                    }

                    const distancia = this.calcularDistancia(
                        this.ubicacionActual.lat, this.ubicacionActual.lng,
                        lat, lng
                    );

                    return {
                        id: g['IDEESS'],
                        nombre: g['R√≥tulo'] || 'Sin nombre',
                        direccion: g['Direcci√≥n'] || '',
                        municipio: g['Municipio'] || '',
                        provincia: g['Provincia'] || '',
                        lat,
                        lng,
                        precio,
                        distancia
                    };
                } catch (error) {
                    return null;
                }
            }

            crearMarcadores(gasolineras) {
                const precios = gasolineras.map(g => g.precio);
                const precioMin = Math.min(...precios);
                const precioMax = Math.max(...precios);
                const rangoTercio = (precioMax - precioMin) / 3;

                gasolineras.forEach((gasolinera, index) => {
                    let categoria = 'barato';
                    if (gasolinera.precio > precioMin + rangoTercio * 2) {
                        categoria = 'caro';
                    } else if (gasolinera.precio > precioMin + rangoTercio) {
                        categoria = 'medio';
                    }

                    // Nombre corto del combustible
                    const abrev = {
                        'Precio Gasoleo A': 'Di√©sel',
                        'Precio Gasolina 95 E5': '95',
                        'Precio Gasolina 98 E5': '98',
                        'Precio Gasoleo Premium': 'Di√©sel+',
                        'Precio Biodiesel': 'Bio',
                        'Precio Bioetanol': 'E85'
                    }[this.combustibleSeleccionado];

                    // Icono personalizado con precio + combustible, siempre visible
                    const icono = L.divIcon({
                        className: `mapa-marker ${categoria}`,
                        html: `<div class="marker-text-container">
                                  <div class="marker-circle ${categoria}"></div>
                                  <div class="marker-text">${gasolinera.precio.toFixed(3)}‚Ç¨ ${abrev}</div>
                               </div>`,
                        iconSize: [80, 30],
                        iconAnchor: [40, 15]
                    });

                    const marker = L.marker([gasolinera.lat, gasolinera.lng], {
                        icon: icono
                    });

                    marker.bindPopup(`
                        <div style="text-align:center; min-width:120px;">
                            <strong>${gasolinera.nombre}</strong><br>
                            <span style="color: ${this.colores[categoria]}; font-weight:bold;">
                                ${gasolinera.precio.toFixed(3)} ‚Ç¨/L ${abrev}
                            </span><br>
                            <small>${gasolinera.distancia.toFixed(1)} km</small>
                        </div>
                    `);

                    marker.on('click', () => this.seleccionarGasolinera(index));
                    marker.addTo(this.mapa);
                    this.marcadores.push(marker);
                });
            }

            actualizarListado(gasolineras) {
                const listado = document.getElementById('listado');
                
                if (gasolineras.length === 0) {
                    listado.innerHTML = `
                        <div class="loading">
                            No hay gasolineras disponibles en el √°rea seleccionada
                        </div>
                    `;
                    return;
                }

                const precios = gasolineras.map(g => g.precio);
                const precioMin = Math.min(...precios);
                const precioMax = Math.max(...precios);
                const rangoTercio = (precioMax - precioMin) / 3;

                const html = gasolineras.map((gasolinera, index) => {
                    let categoria = 'barato';
                    if (gasolinera.precio > precioMin + rangoTercio * 2) {
                        categoria = 'caro';
                    } else if (gasolinera.precio > precioMin + rangoTercio) {
                        categoria = 'medio';
                    }

                    return `
                        <div class="gasolinera-card" data-index="${index}">
                            <div class="gasolinera-header">
                                <div class="gasolinera-nombre">${gasolinera.nombre}</div>
                                <div class="precio-badge ${categoria}">
                                    ${gasolinera.precio.toFixed(3)} ‚Ç¨/L
                                </div>
                            </div>
                            <div class="gasolinera-info">
                                üìç ${gasolinera.direccion}, ${gasolinera.municipio}
                            </div>
                            <div class="gasolinera-acciones">
                                <div class="gasolinera-distancia">
                                    üöó ${gasolinera.distancia.toFixed(1)} km
                                </div>
                                <button class="ruta-btn" onclick="app.abrirRuta(${gasolinera.lat}, ${gasolinera.lng})">
                                    üó∫Ô∏è Ir
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                listado.innerHTML = html;

                listado.querySelectorAll('.gasolinera-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        if (e.target.classList.contains('ruta-btn')) return;
                        const index = parseInt(card.dataset.index);
                        this.seleccionarGasolinera(index);
                    });
                });
            }

            seleccionarGasolinera(index) {
                document.querySelectorAll('.gasolinera-card').forEach(card => {
                    card.classList.remove('selected');
                });

                const card = document.querySelector(`[data-index="${index}"]`);
                if (card) {
                    card.classList.add('selected');
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                if (this.marcadores[index]) {
                    this.marcadores[index].openPopup();
                }

                this.gasolineraSeleccionada = index;
            }

            marcarUbicacionUsuario() {
                if (!this.ubicacionActual) return;

                const marcadorUsuario = L.circleMarker([this.ubicacionActual.lat, this.ubicacionActual.lng], {
                    radius: 8,
                    fillColor: '#1a56db',
                    color: 'white',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 1
                });

                marcadorUsuario.bindPopup('<strong>üìç Tu ubicaci√≥n</strong>');
                marcadorUsuario.addTo(this.mapa);
                this.marcadores.push(marcadorUsuario);
            }

            abrirRuta(lat, lng) {
                const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
                window.open(url, '_blank');
            }

            calcularDistancia(lat1, lon1, lat2, lon2) {
                const R = 6371;
                const dLat = this.toRad(lat2 - lat1);
                const dLon = this.toRad(lon2 - lon1);
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) *
                        Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            toRad(valor) {
                return valor * Math.PI / 180;
            }

            updateMapInfo(mensaje) {
                document.getElementById('mapaInfo').textContent = mensaje;
            }

            showError(mensaje) {
                this.updateMapInfo(`‚ùå ${mensaje}`);
                document.getElementById('listado').innerHTML = `
                    <div class="loading" style="color: #ef4444;">
                        ${mensaje}
                    </div>
                `;
            }

            resetFabButton() {
                const btn = document.getElementById('ubicacionBtn');
                btn.innerHTML = 'üìç';
                btn.style.transform = 'scale(1)';
            }

            getNombreCombustible() {
                const nombres = {
                    'Precio Gasoleo A': 'Di√©sel',
                    'Precio Gasolina 95 E5': 'Gasolina 95',
                    'Precio Gasolina 98 E5': 'Gasolina 98',
                    'Precio Gasoleo Premium': 'Di√©sel Premium',
                    'Precio Biodiesel': 'Biodi√©sel',
                    'Precio Bioetanol': 'Bioetanol'
                };
                return nombres[this.combustibleSeleccionado] || 'combustible';
            }
        }

        // Inicializar la aplicaci√≥n
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new GasolinerasApp();
        });
    </script>
</body>
</html>
