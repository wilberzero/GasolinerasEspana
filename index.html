<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Buscador de Gasolineras</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f5f7fa;
      color: #222;
      margin: 0;
    }
    #controls {
      background: #004aad;
      color: #fff;
      padding: 18px 10px 12px 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      align-items: center;
      border-bottom: 4px solid #006ce4;
    }
    label, select, input, button {
      font-size: 1.07em;
    }
    label { margin-right: 10px; }
    input[type="range"] { vertical-align: middle; }
    input[type="text"], select {
      padding: 5px 8px;
      border-radius: 5px;
      border: none;
    }
    button {
      background: #fff;
      color: #004aad;
      border: none;
      border-radius: 4px;
      padding: 6px 14px;
      font-weight: 600;
      cursor: pointer;
    }
    button:active {
      background: #e4eaff;
    }
    #map {
      height: 51vh;
      width: 100%;
      margin-bottom: 2px;
      box-shadow: 0 2px 16px #0002;
    }
    #listado {
      background: #fff;
      max-height: 45vh;
      overflow: auto;
      padding: 14px;
      margin: 0;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 4px 18px #0001;
    }
    .gasolinera {
      border-bottom: 1px solid #dde;
      padding: 14px 0 8px 0;
      cursor: pointer;
      transition: background 0.15s;
    }
    .gasolinera:last-child { border-bottom: 0;}
    .gasolinera:hover { background: #efe;}
    .gasolinera span { min-width:46px;}
    .precio {
      display: inline-block;
      background: #004aad;
      color: #fff;
      border-radius: 4px;
      font-weight: 700;
      padding: 4px 9px;
      margin-left: 8px;
    }
    .marca {
      font-size: 1em;
      font-weight: 600;
      color: #0253bd;
    }
    .btnRuta { color: #006ce4; text-decoration: underline; cursor:pointer; }
    .seleccionada { background: #dfffc0 !important;}
    @media (max-width:600px) {
      #controls {flex-direction:column; align-items:flex-start;}
      #map { height: 41vh;}
      #listado {max-height: 55vh;}
      html, body {font-size: 15px;}
    }
  </style>
</head>
<body>
  <div id="controls">
    <label>Combustible:
      <select id="combustible">
        <option value="Precio Gasoleo A">Di√©sel</option>
        <option value="Precio Gasolina 95 E5">Gasolina 95</option>
        <option value="Precio Gasolina 98 E5">Gasolina 98</option>
        <option value="Precio Gasoleo Premium">Di√©sel Premium</option>
        <option value="Precio Biodiesel">Biodi√©sel</option>
        <option value="Precio Bioetanol">Bioetanol</option>
      </select>
    </label>
    <button id="btnLocalizar">üìç Mi localizaci√≥n</button>
    <label>O direcci√≥n:
      <input type="text" id="direccion" placeholder="Ej: Madrid o Calle 10, Sevilla"/>
      <button id="btnBuscarDireccion">Buscar</button>
    </label>
    <label>Radio:
      <span id="valorKm">5</span>km
      <input type="range" id="radioKm" min="1" max="80" value="5" step="1"/>
    </label>
  </div>
  <div id="map"></div>
  <div id="listado"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
  // Utilidad Haversine
  function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2-lat1) * Math.PI/180;
    const dLon = (lon2-lon1) * Math.PI/180;
    const a = Math.sin(dLat/2)*Math.sin(dLat/2) +
      Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  let myLat = null, myLon = null;
  let gasolineras = [];
  let mapa = null, capaMarkers = null, referenciaMarcadores = [];

  const btnLocalizar = document.getElementById('btnLocalizar');
  const btnBuscarDireccion = document.getElementById('btnBuscarDireccion');
  const direccionInput = document.getElementById('direccion');
  const radioKmInput = document.getElementById('radioKm');
  const valorKmSpan = document.getElementById('valorKm');
  const combustibleSel = document.getElementById('combustible');
  const listadoDiv = document.getElementById('listado');

  function inicializarMapa() {
    mapa = L.map('map').setView([40.4167,-3.70325], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(mapa);
    capaMarkers = L.layerGroup().addTo(mapa);
  }
  inicializarMapa();

  radioKmInput.addEventListener('input', ()=>{
    valorKmSpan.textContent = radioKmInput.value;
    if(myLat && myLon) mostrarGasolineras();
  });

  combustibleSel.addEventListener('change', ()=>{
    if(myLat && myLon) mostrarGasolineras();
  });

  btnBuscarDireccion.addEventListener('click', buscarDireccion);

  function buscarDireccion() {
    const txt = direccionInput.value;
    if(!txt) {
      alert("Introduce una direcci√≥n o ciudad.");
      return;
    }
    fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(txt))
    .then(r=>r.json())
    .then(res=>{
      if(res.length) {
        myLat = parseFloat(res[0].lat);
        myLon = parseFloat(res[0].lon);
        mapa.setView([myLat, myLon], 14);
        mostrarGasolineras();
      } else {
        alert("Direcci√≥n no encontrada");
      }
    });
  }

  btnLocalizar.addEventListener('click', ()=>{
    if(navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos=>{
        myLat = pos.coords.latitude;
        myLon = pos.coords.longitude;
        mapa.setView([myLat, myLon], 14);
        mostrarGasolineras();
      },()=>{
        alert("No se pudo acceder a tu ubicaci√≥n");
      });
    }
  });

  async function cargarGasolineras(){
    listadoDiv.innerHTML = "Cargando datos oficiales de gasolineras...";
    const res = await fetch('https://sedeaplicaciones.minetur.gob.es/ServiciosRESTCarburantes/PreciosCarburantes/EstacionesTerrestres/');
    const data = await res.json();
    gasolineras = data.ListaEESSPrecio.map(gaso => ({
      nombre: gaso["R√≥tulo"],
      direccion: gaso["Direcci√≥n"],
      municipio: gaso["Municipio"],
      provincia: gaso["Provincia"],
      lat: parseFloat(gaso["Latitud"].replace(",", ".")),
      lon: parseFloat(gaso["Longitud (WGS84)"].replace(",", ".")),
      precios: {
        'Precio Gasolina 95 E5': parseFloat((gaso["Precio Gasolina 95 E5"]||"0").replace(",",".")||0),
        'Precio Gasolina 98 E5': parseFloat((gaso["Precio Gasolina 98 E5"]||"0").replace(",",".")||0),
        'Precio Gasoleo A': parseFloat((gaso["Precio Gasoleo A"]||"0").replace(",",".")||0),
        'Precio Gasoleo Premium': parseFloat((gaso["Precio Gasoleo Premium"]||"0").replace(",",".")||0),
        'Precio Biodiesel': parseFloat((gaso["Precio Biodiesel"]||"0").replace(",",".")||0),
        'Precio Bioetanol': parseFloat((gaso["Precio Bioetanol"]||"0").replace(",",".")||0),
      }
    }));
    listadoDiv.innerHTML = "Introduce tu ubicaci√≥n o busca una direcci√≥n para empezar.";
  }
  cargarGasolineras();

  function mostrarGasolineras() {
    listadoDiv.innerHTML = "Buscando gasolineras cercanas...";
    capaMarkers.clearLayers();
    referenciaMarcadores = [];
    if(myLat==null || myLon==null || gasolineras.length==0) {
      listadoDiv.innerHTML = "Introduce ubicaci√≥n.";
      return;
    }
    const radio = parseInt(radioKmInput.value);
    const tipo = combustibleSel.value;
    let cercanas = gasolineras
      .map(gaso => {
        const dist = haversine(myLat, myLon, gaso.lat, gaso.lon);
        const precio = gaso.precios[tipo] && gaso.precios[tipo]>0 ? gaso.precios[tipo] : null;
        return {...gaso, dist, precio};
      })
      .filter(gaso => gaso.precio !== null && gaso.dist <= radio)
      .sort((a,b) => a.dist - b.dist);

    if(cercanas.length==0) {
      listadoDiv.innerHTML = `<p>No hay gasolineras en ${radio} km con precios de este carburante.</p>`;
      return;
    }
    mapa.setView([myLat, myLon], radio <= 3 ? 15 : radio <=10 ? 12 : 10);

    // A√±ade marcador del usuario
    L.marker([myLat, myLon], {
      title:"T√∫",
      icon: L.icon({
        iconUrl:"https://cdn-icons-png.flaticon.com/512/64/64113.png",
        iconSize:[32,32]
      })
    }).addTo(capaMarkers);

    // Marcadores gasolineras con marca/precio y referencia para resaltar
    cercanas.forEach((gaso, idx) => {
      const iconHtml = `
        <div style="background:#fff; border:2px solid #004aad; border-radius:6px; padding:5px 10px; box-shadow:0 1px 6px #156fff33; min-width:70px; text-align:center;">
          <span style="font-weight:600;font-size:1em;color:#004aad;line-height:1.1;">${gaso.nombre}</span>
          <div class="precio" style="margin:2px auto 0px auto;display:inline-block;">${gaso.precio.toFixed(3)} ‚Ç¨/l</div>
        </div>
      `;
      const icon = L.divIcon({className: '', html: iconHtml, iconAnchor:[35,50]});
      const marker = L.marker([gaso.lat, gaso.lon], {icon, title: gaso.nombre});
      marker.bindPopup(`
        <b>${gaso.nombre}</b><br>${gaso.direccion}, ${gaso.municipio}<br>
        <span class="precio">${gaso.precio.toFixed(3)} ‚Ç¨/l</span>
        <br><a href="https://www.google.com/maps/dir/?api=1&destination=${gaso.lat},${gaso.lon}" target="_blank">Ruta üöó</a>
      `);
      marker._listIdx = idx;
      marker.on('click', function() {
        resaltaEnListado(idx, true);
      });
      marker.addTo(capaMarkers);
      referenciaMarcadores.push(marker);
    });

    listadoDiv.innerHTML = cercanas.slice(0,40).map((gaso, i)=>`
      <div class="gasolinera" data-idx="${i}">
        <span class="marca">${gaso.nombre}</span>
        <span class="precio">${gaso.precio.toFixed(3)} ‚Ç¨/l</span>
        <br><span>${gaso.direccion}, ${gaso.municipio} (${gaso.provincia})</span>
        <br><span style="color:#888;">${gaso.dist.toFixed(1)} km</span>
        <br><span class="btnRuta" onclick="event.stopPropagation();window.open('https://www.google.com/maps/dir/?api=1&destination=${gaso.lat},${gaso.lon}','_blank')">Ir üöó</span>
      </div>
    `).join('');

    // Sincronizar clicks en listado con el mapa
    Array.from(listadoDiv.querySelectorAll('.gasolinera')).forEach((elem, idx) => {
      elem.onclick = function(){
        centrarYPopup(cercanas[idx].lat, cercanas[idx].lon, idx);
        resaltaEnListado(idx, false);
      };
    });
  }

  function centrarYPopup(lat, lon, idx) {
    mapa.setView([lat,lon], 15);
    const marker = referenciaMarcadores[idx];
    if(marker) marker.openPopup();
  }
  function resaltaEnListado(idx, desdeMapa) {
    Array.from(listadoDiv.querySelectorAll('.gasolinera')).forEach(i => i.classList.remove('seleccionada'));
    const lista = listadoDiv.querySelectorAll('.gasolinera');
    if(lista[idx]){
      lista[idx].classList.add('seleccionada');
      lista[idx].scrollIntoView({behavior:"smooth", block:"center"});
      if(desdeMapa) setTimeout(()=>lista[idx].classList.remove('seleccionada'), 2400);
    }
  }
  </script>
</body>
</html>
